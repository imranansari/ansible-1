---
- hosts: prometheus
  vars:
    # Prometheus version and checksum configuration
    - prometheus_version: "0.18.0rc1"
    - prometheus_sha1: "915b0396b9ed973842c3c3e5394caec24269fa37"
    # Prometheus configuration and data storage locations
    - prometheus_config: "/etc/prometheus/prometheus.yml"
    - prometheus_data: "/var/lib/prometheus/"
    # Prometheus jobs configuration
    - prometheus_jobs:
      - job: "edgemax"
        targets:
          - "192.168.1.3:9132"
      - job: "node"
        targets:
          - "192.168.1.3:9100"
          - "192.168.1.5:9100"
          - "192.168.1.20:9100"
      - job: "prometheus"
        scrape_interval: "5s"
        targets:
          - "192.168.1.3:9090"
      - job: "rtorrent"
        scrape_interval: "5s"
        targets:
          - "192.168.1.3:9135"
      - job: "unifi"
        targets:
          - "unifi.servnerr.com:9130"
      - job: "zfs"
        targets:
          - "192.168.1.3:9134"
    # Static configuration.
    - prometheus_dir: "prometheus-{{ prometheus_version }}.linux-amd64"
    - prometheus_tmp: "/tmp/{{ prometheus_dir }}"
    - prometheus_url: "https://github.com/prometheus/prometheus/releases/download/{{ prometheus_version }}/{{ prometheus_dir }}.tar.gz"
    - prometheus_tgz: "/tmp/prometheus.tar.gz"
  tasks:
    - name: stop prometheus service
      service: name=prometheus state=stopped

    - name: download and checksum prometheus tarball
      get_url: url={{ prometheus_url }} dest={{ prometheus_tgz }} checksum=sha1:{{ prometheus_sha1 }}

    - name: unpack tarball
      unarchive: src={{ prometheus_tgz }} dest=/tmp/ copy=no

    - name: create prometheus user
      user: name=prometheus shell=/bin/false comment="prometheus service user"

    - name: copy prometheus binary to /usr/local/bin
      copy: src={{ prometheus_tmp }}/prometheus dest=/usr/local/bin/ owner=prometheus group=prometheus mode=0755

    - name: copy promtool binary to /usr/local/bin
      copy: src={{ prometheus_tmp }}/promtool dest=/usr/local/bin/ owner=prometheus group=prometheus mode=0755

    - name: create prometheus configuration
      template: src=templates/prometheus.yml.j2 dest={{ prometheus_config }}
      with_items: "{{ prometheus_jobs }}"

    - name: create prometheus data directory
      file: path={{ prometheus_data }} state=directory owner=prometheus group=prometheus mode=0755

    - name: create prometheus upstart job
      template: src=templates/prometheus.conf.j2 dest=/etc/init/prometheus.conf

    - name: start prometheus service
      service: name=prometheus state=started enabled=yes

    - name: remove temporary prometheus directory
      file: path={{ prometheus_tmp }} state=absent

    - name: remove temporary prometheus tarball
      file: path={{ prometheus_tgz }} state=absent
